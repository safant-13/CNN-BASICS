<!DOCTYPE html>
<html>
<head>
    <title>Model Weight Checker</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
</head>
<body>
    <h1>Model Weight Diagnostic</h1>
    <pre id="output"></pre>
    
    <script>
        async function checkModel() {
            const output = document.getElementById('output');
            
            try {
                // Load and inspect the model JSON
                const response = await fetch('./model/model.json');
                const modelJson = await response.json();
                
                output.textContent += 'Model Format: ' + modelJson.format + '\n';
                output.textContent += 'Generated By: ' + modelJson.generatedBy + '\n';
                output.textContent += 'Converted By: ' + modelJson.convertedBy + '\n\n';
                
                // Check weight manifest
                output.textContent += 'Weight Manifest:\n';
                if (modelJson.weightsManifest) {
                    modelJson.weightsManifest.forEach((group, idx) => {
                        output.textContent += `\nGroup ${idx}:\n`;
                        output.textContent += `  Paths: ${JSON.stringify(group.paths)}\n`;
                        output.textContent += `  Weights:\n`;
                        group.weights.forEach(w => {
                            output.textContent += `    - ${w.name} (shape: ${JSON.stringify(w.shape)}, dtype: ${w.dtype})\n`;
                        });
                    });
                }
                
                // Check model topology
                output.textContent += '\n\nModel Topology:\n';
                if (modelJson.modelTopology && modelJson.modelTopology.model_config) {
                    const config = modelJson.modelTopology.model_config;
                    output.textContent += `  Class: ${config.class_name}\n`;
                    output.textContent += `  Name: ${config.config.name}\n`;
                    
                    // Check layers
                    output.textContent += '\n  Layers:\n';
                    config.config.layers.forEach((layer, idx) => {
                        output.textContent += `    ${idx}. ${layer.class_name}`;
                        if (layer.config.name) {
                            output.textContent += ` (name: ${layer.config.name})`;
                        }
                        output.textContent += '\n';
                    });
                }
                
                // Try to load weights directly
                output.textContent += '\n\nAttempting to load weights:\n';
                const weightResponse = await fetch('./model/group1-shard1of1.bin');
                const weightBuffer = await weightResponse.arrayBuffer();
                output.textContent += `  Weight file size: ${weightBuffer.byteLength} bytes\n`;
                
                // Calculate expected size
                let expectedSize = 0;
                modelJson.weightsManifest[0].weights.forEach(w => {
                    let size = 4; // float32 = 4 bytes
                    w.shape.forEach(dim => size *= dim);
                    expectedSize += size;
                    output.textContent += `  ${w.name}: ${size} bytes\n`;
                });
                output.textContent += `  Total expected: ${expectedSize} bytes\n`;
                output.textContent += `  Match: ${expectedSize === weightBuffer.byteLength ? 'YES' : 'NO'}\n`;
                
                // Try different loading approaches
                output.textContent += '\n\nTrying different model names:\n';
                
                // Option 1: Remove 'sequential/' prefix
                const option1 = JSON.parse(JSON.stringify(modelJson));
                option1.weightsManifest[0].weights.forEach(w => {
                    if (w.name.startsWith('sequential/')) {
                        w.name = w.name.replace('sequential/', '');
                    }
                });
                output.textContent += 'Option 1 - Without sequential/ prefix:\n';
                option1.weightsManifest[0].weights.forEach(w => {
                    output.textContent += `  - ${w.name}\n`;
                });
                
                // Option 2: Use model name from config
                const option2 = JSON.parse(JSON.stringify(modelJson));
                const modelName = modelJson.modelTopology.model_config.config.name || 'model';
                option2.weightsManifest[0].weights.forEach(w => {
                    if (w.name.startsWith('sequential/')) {
                        w.name = w.name.replace('sequential/', modelName + '/');
                    }
                });
                output.textContent += '\nOption 2 - With model name:\n';
                option2.weightsManifest[0].weights.forEach(w => {
                    output.textContent += `  - ${w.name}\n`;
                });
                
            } catch (error) {
                output.textContent += '\n\nError: ' + error.message + '\n' + error.stack;
            }
        }
        
        checkModel();
    </script>
</body>
</html>
